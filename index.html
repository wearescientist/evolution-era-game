<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¿›åŒ–çºªå…ƒ - æ¨¡æ‹Ÿç»è¥</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #0a1628 0%, #1a2a4a 50%, #0d1b2a 100%);
            min-height: 100vh;
            color: #fff;
            overflow: hidden;
        }
        
        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
            display: grid;
            grid-template-columns: 260px 1fr;
            grid-template-rows: 1fr auto;
            gap: 10px;
            height: 100vh;
        }
        
        @media (max-width: 900px) {
            .game-container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto auto;
            }
            .left-panel {
                display: none;
            }
            .mobile-resources {
                display: flex !important;
            }
        }
        
        /* å·¦ä¾§é¢æ¿ - è®¾æ–½åˆ—è¡¨ */
        .left-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .panel-header {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .facility-count {
            font-size: 0.8em;
            color: #00ffff;
            background: rgba(0, 255, 255, 0.1);
            padding: 4px 10px;
            border-radius: 10px;
        }
        
        .facility-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .facility-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        
        .facility-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(0, 255, 255, 0.3);
        }
        
        .facility-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .facility-name {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .facility-level {
            font-size: 0.75em;
            color: #00ffff;
            background: rgba(0, 255, 255, 0.15);
            padding: 2px 8px;
            border-radius: 8px;
        }
        
        .facility-output {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 10px;
        }
        
        .facility-actions {
            display: flex;
            gap: 8px;
        }
        
        .facility-btn {
            flex: 1;
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            font-size: 0.75em;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-upgrade {
            background: linear-gradient(135deg, #00aa66, #00ff88);
            color: #000;
        }
        
        .btn-upgrade:hover {
            transform: scale(1.05);
        }
        
        .btn-upgrade:disabled {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-remove {
            background: rgba(255, 80, 80, 0.3);
            color: #ff5555;
        }
        
        .btn-remove:hover {
            background: rgba(255, 80, 80, 0.5);
        }
        
        /* ä¸­é—´æ¸¸æˆåŒºåŸŸ */
        .center-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 10px 15px;
        }
        
        .stage-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .stage-badge {
            background: linear-gradient(135deg, rgba(0, 200, 200, 0.3), rgba(0, 150, 255, 0.3));
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: bold;
            color: #00ffff;
        }
        
        .resources-bar {
            display: flex;
            gap: 15px;
        }
        
        .resource-mini {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
        }
        
        .resource-mini .value {
            font-weight: bold;
            color: #00ff88;
        }
        
        .canvas-container {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
            cursor: grab;
        }
        
        #gameCanvas:active {
            cursor: grabbing;
        }
        
        .canvas-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
        }
        
        .zone-indicator {
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            backdrop-filter: blur(5px);
        }
        
        .zone-indicator.nutrient { color: #00ff88; border: 1px solid rgba(0, 255, 136, 0.3); }
        .zone-indicator.danger { color: #ff5555; border: 1px solid rgba(255, 85, 85, 0.3); }
        .zone-indicator.normal { color: #aaa; border: 1px solid rgba(255, 255, 255, 0.2); }
        
        /* åº•éƒ¨éƒ¨ç½²èœå• */
        .deploy-menu {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
        }
        
        .deploy-menu.visible {
            display: block;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .deploy-title {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 10px;
            text-align: center;
        }
        
        .deploy-options {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .deploy-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .deploy-card:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(0, 255, 255, 0.5);
            transform: translateY(-3px);
        }
        
        .deploy-card.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .deploy-card.disabled:hover {
            transform: none;
            border-color: transparent;
        }
        
        .deploy-icon {
            font-size: 2em;
            margin-bottom: 8px;
        }
        
        .deploy-name {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .deploy-cost {
            font-size: 0.75em;
            color: #00ff88;
        }
        
        .deploy-cost.cannot-afford {
            color: #ff5555;
        }
        
        /* è¿›åŒ–è¿›åº¦æ¡ */
        .evolution-bar {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 12px 15px;
        }
        
        .evolution-progress {
            height: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .evolution-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ffff, #0088ff, #8800ff);
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
        }
        
        .evolution-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .evolution-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .evolution-text {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .evolve-btn {
            padding: 8px 20px;
            background: linear-gradient(135deg, #00ffff, #0088ff);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.5;
            pointer-events: none;
        }
        
        .evolve-btn.active {
            opacity: 1;
            pointer-events: auto;
            animation: pulse 1.5s infinite;
        }
        
        .evolve-btn.active:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 10px rgba(0, 255, 255, 0.3); }
            50% { box-shadow: 0 0 25px rgba(0, 255, 255, 0.6); }
        }
        
        /* æµ®åŠ¨æ–‡å­—æ•ˆæœ */
        .floating-text {
            position: absolute;
            pointer-events: none;
            font-weight: bold;
            font-size: 0.9em;
            animation: floatUp 1.2s ease-out forwards;
            text-shadow: 0 0 10px currentColor;
            z-index: 100;
        }
        
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-60px) scale(1.1); }
        }
        
        /* æ§åˆ¶æç¤º */
        .controls-hint {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.6);
            pointer-events: none;
        }
        
        /* ç§»åŠ¨ç«¯èµ„æºæ¡ */
        .mobile-resources {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 10px;
            gap: 10px;
            overflow-x: auto;
        }
        
        .mobile-resource-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85em;
            white-space: nowrap;
        }
        
        /* ä¿å­˜æŒ‰é’® */
        .save-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
            z-index: 100;
        }
        
        .save-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8em;
        }
        
        .save-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* å™¨å®˜æç¤º */
        .organ-hint {
            background: rgba(136, 68, 255, 0.15);
            border: 1px solid rgba(136, 68, 255, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.8em;
        }
        
        .organ-hint-title {
            color: #aa66ff;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .organ-list {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .organ-tag {
            background: rgba(136, 68, 255, 0.2);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75em;
        }
        
        .organ-tag.formed {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- å·¦ä¾§é¢æ¿ï¼šè®¾æ–½åˆ—è¡¨ -->
        <div class="left-panel">
            <div class="panel-header">
                <span>å·²éƒ¨ç½²è®¾æ–½</span>
                <span class="facility-count"><span id="facilityCount">0</span>/<span id="maxFacilityCount">1</span></span>
            </div>
            <div class="facility-list" id="facilityList">
                <!-- è®¾æ–½åˆ—è¡¨åŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <!-- å™¨å®˜æç¤ºï¼ˆé˜¶æ®µ2æ˜¾ç¤ºï¼‰ -->
            <div class="organ-hint" id="organHint" style="display: none;">
                <div class="organ-hint-title">ğŸ§¬ å™¨å®˜å½¢æˆè¿›åº¦</div>
                <div class="organ-list" id="organList">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <!-- ä¸­é—´åŒºåŸŸ -->
        <div class="center-area">
            <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
            <div class="top-bar">
                <div class="stage-info">
                    <div class="stage-badge" id="stageBadge">é˜¶æ®µ1: å•ç»†èƒ</div>
                </div>
                <div class="resources-bar" id="resourcesBar">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- æ¸¸æˆç”»å¸ƒ -->
            <div class="canvas-container" id="canvasContainer">
                <canvas id="gameCanvas"></canvas>
                <div class="canvas-overlay">
                    <div class="zone-indicator normal" id="zoneIndicator">ğŸ“ æ™®é€šåŒºåŸŸ</div>
                </div>
                <div class="controls-hint">WASD/æ–¹å‘é”®ç§»åŠ¨ æˆ– è§¦æ‘¸æ‹–åŠ¨</div>
            </div>
            
            <!-- è¿›åŒ–è¿›åº¦ -->
            <div class="evolution-bar">
                <div class="evolution-progress">
                    <div class="evolution-fill" id="evolutionFill" style="width: 0%"></div>
                </div>
                <div class="evolution-info">
                    <span class="evolution-text">è¿›åŒ–è¿›åº¦: <span id="evolutionPercent">0%</span></span>
                    <button class="evolve-btn" id="evolveBtn" onclick="game.attemptEvolution()">âœ¨ è¿›åŒ–</button>
                </div>
            </div>
            
            <!-- åº•éƒ¨éƒ¨ç½²èœå• -->
            <div class="deploy-menu" id="deployMenu">
                <div class="deploy-title">ğŸ› ï¸ å¯éƒ¨ç½²è®¾æ–½</div>
                <div class="deploy-options" id="deployOptions">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <!-- ç§»åŠ¨ç«¯èµ„æºæ¡ -->
        <div class="mobile-resources" id="mobileResources">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
    
    <!-- ä¿å­˜æ§åˆ¶ -->
    <div class="save-controls">
        <button class="save-btn" onclick="game.saveGame()">ğŸ’¾ ä¿å­˜</button>
        <button class="save-btn" onclick="game.hardReset()">ğŸ”„ é‡ç½®</button>
    </div>

    <script>
        // ==================== æ¸¸æˆæ ¸å¿ƒç±» ====================
        class EvolutionGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.lastTime = 0;
                
                // æ¸¸æˆçŠ¶æ€
                this.stage = 1;
                this.playTime = 0;
                this.paused = false;
                
                // ç©å®¶ä½ç½®
                this.player = {
                    x: 0,
                    y: 0,
                    radius: 20,
                    speed: 150,
                    targetX: null,
                    targetY: null,
                    isMoving: false
                };
                
                // è¾“å…¥çŠ¶æ€
                this.keys = {};
                this.touchStartX = null;
                this.touchStartY = null;
                
                // åœ°å›¾é…ç½®
                this.mapWidth = 2000;
                this.mapHeight = 1500;
                this.camera = { x: 0, y: 0 };
                
                // ç”Ÿæ€åŒºåŸŸ
                this.zones = [];
                this.currentZone = 'normal';
                
                // èµ„æºç³»ç»Ÿ
                this.resources = {
                    nutrients: 20,
                    energy: 10,
                    cells: 1
                };
                
                this.resourceCaps = {
                    nutrients: 100,
                    energy: 100
                };
                
                // è®¾æ–½ç³»ç»Ÿ
                this.facilities = [];
                this.facilityTypes = {
                    cilia: {
                        name: 'çº¤æ¯›æ”¶é›†å™¨',
                        icon: 'ğŸŒŠ',
                        cost: { nutrients: 10 },
                        output: { nutrients: 0.5 },
                        description: 'è‡ªåŠ¨æ”¶é›†å‘¨å›´è¥å…»',
                        color: '#00ff88'
                    },
                    metabolism: {
                        name: 'ä»£è°¢å›Š',
                        icon: 'âš¡',
                        cost: { nutrients: 20 },
                        output: { energy: 0.3 },
                        description: 'å°†è¥å…»è½¬åŒ–ä¸ºèƒ½é‡',
                        color: '#ffaa00'
                    },
                    membrane: {
                        name: 'ç»†èƒè†œå¼ºåŒ–',
                        icon: 'ğŸ›¡ï¸',
                        cost: { energy: 30 },
                        output: { defense: 1 },
                        description: 'å¢åŠ é˜²å¾¡èŒƒå›´å’Œèµ„æºä¸Šé™',
                        color: '#0088ff'
                    }
                };
                
                // é˜¶æ®µ2è®¾æ–½
                this.stage2Facilities = {
                    nerve: {
                        name: 'ç¥ç»ç»†èƒèŠ‚ç‚¹',
                        icon: 'ğŸ§ ',
                        cost: { nutrients: 30 },
                        output: { signals: 0.2 },
                        description: 'äº§ç”Ÿä¿¡å·èµ„æº',
                        color: '#8844ff'
                    },
                    muscle: {
                        name: 'è‚Œè‚‰çº¤ç»´',
                        icon: 'ğŸ’ª',
                        cost: { nutrients: 25, energy: 10 },
                        output: { energy: 0.5 },
                        description: 'äº§ç”Ÿèƒ½é‡',
                        color: '#ff4444'
                    },
                    digestive: {
                        name: 'æ¶ˆåŒ–è…ºä½“',
                        icon: 'ğŸ½ï¸',
                        cost: { nutrients: 20 },
                        output: { nutrients: 0.4 },
                        description: 'å¸æ”¶ç¯å¢ƒè¥å…»',
                        color: '#44ff44'
                    }
                };
                
                // é˜¶æ®µ2èµ„æº
                this.stage2Resources = {
                    signals: 0,
                    nerveNodes: 0,
                    muscleFibers: 0,
                    digestiveGlands: 0
                };
                
                this.stage2Caps = {
                    signals: 50
                };
                
                // å™¨å®˜ç³»ç»Ÿ
                this.organs = {
                    heart: { formed: false, required: { muscle: 3, nerve: 2 } },
                    brain: { formed: false, required: { nerve: 5, muscle: 2 } },
                    digestive: { formed: false, required: { digestive: 3, muscle: 2 } }
                };
                
                // é˜¶æ®µ3
                this.stage3Resources = {
                    food: 0,
                    swarmPoints: 0,
                    territories: 0,
                    patrols: 0,
                    breedingPoints: 0
                };
                
                this.stage3Caps = {
                    food: 500,
                    swarmPoints: 1000
                };
                
                this.territoryData = [];
                this.swarmSize = 1;
                
                // é˜¶æ®µ3è®¾æ–½
                this.stage3Facilities = {
                    territory: {
                        name: 'æ ‡è®°é¢†åœ°',
                        icon: 'ğŸš©',
                        cost: { swarmPoints: 50 },
                        output: { food: 1 },
                        description: 'å é¢†åŒºåŸŸï¼Œè‡ªåŠ¨äº§ç”Ÿé£Ÿç‰©',
                        color: '#00ff88'
                    },
                    patrol: {
                        name: 'éƒ¨ç½²å·¡é€»é˜Ÿ',
                        icon: 'ğŸ‘ï¸',
                        cost: { food: 30 },
                        output: { defense: 1 },
                        description: 'ä¿æŠ¤é¢†åœ°ä¸è¢«æŠ¢å¤º',
                        color: '#ffaa00'
                    },
                    breeding: {
                        name: 'å»ºç«‹ç¹æ®–ç‚¹',
                        icon: 'ğŸ¥š',
                        cost: { food: 50, swarmPoints: 20 },
                        output: { swarmGrowth: 0.1 },
                        description: 'è‡ªåŠ¨å¢åŠ é±¼ç¾¤æ•°é‡',
                        color: '#ff66aa'
                    }
                };
                
                // è§†è§‰æ•ˆæœ
                this.particles = [];
                this.floatingTexts = [];
                this.facilityAnimations = [];
                
                this.init();
            }
            
            init() {
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
                
                // åˆå§‹åŒ–ç©å®¶ä½ç½®åœ¨åœ°å›¾ä¸­å¿ƒ
                this.player.x = this.mapWidth / 2;
                this.player.y = this.mapHeight / 2;
                this.updateCamera();
                
                // ç”Ÿæˆç”Ÿæ€åŒºåŸŸ
                this.generateZones();
                
                // è¾“å…¥æ§åˆ¶
                this.setupControls();
                
                // åŠ è½½å­˜æ¡£
                this.loadGame();
                
                // å¼€å§‹æ¸¸æˆå¾ªç¯
                requestAnimationFrame((t) => this.gameLoop(t));
                
                // æ¯ç§’æ›´æ–°
                setInterval(() => this.secondUpdate(), 1000);
                
                // åˆå§‹UIæ›´æ–°
                this.updateUI();
            }
            
            resizeCanvas() {
                const container = document.getElementById('canvasContainer');
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;
            }
            
            generateZones() {
                // ç”Ÿæˆè¥å…»åŒº
                for (let i = 0; i < 8; i++) {
                    this.zones.push({
                        type: 'nutrient',
                        x: Math.random() * this.mapWidth,
                        y: Math.random() * this.mapHeight,
                        radius: 80 + Math.random() * 60,
                        color: 'rgba(0, 255, 136, 0.15)'
                    });
                }
                
                // ç”Ÿæˆå±é™©åŒº
                for (let i = 0; i < 4; i++) {
                    this.zones.push({
                        type: 'danger',
                        x: Math.random() * this.mapWidth,
                        y: Math.random() * this.mapHeight,
                        radius: 60 + Math.random() * 40,
                        color: 'rgba(255, 85, 85, 0.15)'
                    });
                }
            }
            
            setupControls() {
                // é”®ç›˜æ§åˆ¶
                window.addEventListener('keydown', (e) => {
                    this.keys[e.key.toLowerCase()] = true;
                });
                
                window.addEventListener('keyup', (e) => {
                    this.keys[e.key.toLowerCase()] = false;
                });
                
                // è§¦æ‘¸æ§åˆ¶
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const rect = this.canvas.getBoundingClientRect();
                    this.touchStartX = touch.clientX - rect.left;
                    this.touchStartY = touch.clientY - rect.top;
                    this.player.targetX = this.touchStartX + this.camera.x;
                    this.player.targetY = this.touchStartY + this.camera.y;
                    this.player.isMoving = true;
                }, { passive: false });
                
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const rect = this.canvas.getBoundingClientRect();
                    this.player.targetX = touch.clientX - rect.left + this.camera.x;
                    this.player.targetY = touch.clientY - rect.top + this.camera.y;
                }, { passive: false });
                
                this.canvas.addEventListener('touchend', () => {
                    this.player.isMoving = false;
                    this.player.targetX = null;
                    this.player.targetY = null;
                });
                
                // é¼ æ ‡ç‚¹å‡»ç§»åŠ¨
                this.canvas.addEventListener('mousedown', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    this.player.targetX = e.clientX - rect.left + this.camera.x;
                    this.player.targetY = e.clientY - rect.top + this.camera.y;
                    this.player.isMoving = true;
                });
                
                this.canvas.addEventListener('mouseup', () => {
                    this.player.isMoving = false;
                    this.player.targetX = null;
                    this.player.targetY = null;
                });
            }
            
            // ==================== æ¸¸æˆå¾ªç¯ ====================
            gameLoop(timestamp) {
                const deltaTime = (timestamp - this.lastTime) / 1000;
                this.lastTime = timestamp;
                
                if (!this.paused && deltaTime < 0.1) {
                    this.update(deltaTime);
                    this.render();
                }
                
                requestAnimationFrame((t) => this.gameLoop(t));
            }
            
            update(dt) {
                // æ›´æ–°ç©å®¶ç§»åŠ¨
                this.updatePlayerMovement(dt);
                
                // æ›´æ–°ç›¸æœº
                this.updateCamera();
                
                // æ£€æµ‹å½“å‰åŒºåŸŸ
                this.checkCurrentZone();
                
                // æ›´æ–°èµ„æº
                this.updateResources(dt);
                
                // æ›´æ–°è®¾æ–½
                this.updateFacilities(dt);
                
                // æ›´æ–°ç²’å­
                this.updateParticles(dt);
                
                // æ£€æŸ¥è¿›åŒ–æ¡ä»¶
                this.checkEvolution();
                
                // é˜¶æ®µç‰¹å®šæ›´æ–°
                if (this.stage >= 2) {
                    this.updateStage2(dt);
                }
                if (this.stage >= 3) {
                    this.updateStage3(dt);
                }
            }
            
            updatePlayerMovement(dt) {
                let dx = 0;
                let dy = 0;
                
                // é”®ç›˜è¾“å…¥
                if (this.keys['w'] || this.keys['arrowup']) dy -= 1;
                if (this.keys['s'] || this.keys['arrowdown']) dy += 1;
                if (this.keys['a'] || this.keys['arrowleft']) dx -= 1;
                if (this.keys['d'] || this.keys['arrowright']) dx += 1;
                
                // è§¦æ‘¸/é¼ æ ‡ç›®æ ‡ç§»åŠ¨
                if (this.player.isMoving && this.player.targetX !== null) {
                    const targetDx = this.player.targetX - this.player.x;
                    const targetDy = this.player.targetY - this.player.y;
                    const dist = Math.sqrt(targetDx * targetDx + targetDy * targetDy);
                    
                    if (dist > 5) {
                        dx = targetDx / dist;
                        dy = targetDy / dist;
                    } else {
                        this.player.isMoving = false;
                    }
                }
                
                // åº”ç”¨ç§»åŠ¨
                if (dx !== 0 || dy !== 0) {
                    // å½’ä¸€åŒ–
                    if (dx !== 0 && dy !== 0) {
                        const len = Math.sqrt(dx * dx + dy * dy);
                        dx /= len;
                        dy /= len;
                    }
                    
                    this.player.x += dx * this.player.speed * dt;
                    this.player.y += dy * this.player.speed * dt;
                    
                    // è¾¹ç•Œé™åˆ¶
                    this.player.x = Math.max(this.player.radius, Math.min(this.mapWidth - this.player.radius, this.player.x));
                    this.player.y = Math.max(this.player.radius, Math.min(this.mapHeight - this.player.radius, this.player.y));
                }
            }
            
            updateCamera() {
                // ç›¸æœºè·Ÿéšç©å®¶
                this.camera.x = this.player.x - this.canvas.width / 2;
                this.camera.y = this.player.y - this.canvas.height / 2;
                
                // é™åˆ¶ç›¸æœºèŒƒå›´
                this.camera.x = Math.max(0, Math.min(this.mapWidth - this.canvas.width, this.camera.x));
                this.camera.y = Math.max(0, Math.min(this.mapHeight - this.canvas.height, this.camera.y));
            }
            
            checkCurrentZone() {
                let inZone = 'normal';
                
                for (const zone of this.zones) {
                    const dx = this.player.x - zone.x;
                    const dy = this.player.y - zone.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    if (dist < zone.radius) {
                        inZone = zone.type;
                        break;
                    }
                }
                
                if (this.currentZone !== inZone) {
                    this.currentZone = inZone;
                    this.updateZoneIndicator();
                    this.updateDeployMenu();
                }
            }
            
            updateResources(dt) {
                // é˜¶æ®µ1èµ„æºè‡ªç„¶æ¢å¤
                if (this.stage === 1) {
                    // æ™®é€šåŒºåŸŸç¼“æ…¢æ¢å¤
                    if (this.currentZone === 'normal') {
                        this.resources.nutrients = Math.min(
                            this.resources.nutrients + 0.1 * dt,
                            this.resourceCaps.nutrients
                        );
                    }
                    // è¥å…»åŒºé¢å¤–æ¢å¤
                    if (this.currentZone === 'nutrient') {
                        this.resources.nutrients = Math.min(
                            this.resources.nutrients + 0.3 * dt,
                            this.resourceCaps.nutrients
                        );
                    }
                }
                
                // é˜¶æ®µ2èµ„æº
                if (this.stage >= 2) {
                    // ä¿¡å·è¡°å‡
                    this.stage2Resources.signals = Math.max(0, this.stage2Resources.signals - 0.05 * dt);
                }
                
                // é˜¶æ®µ3èµ„æº
                if (this.stage >= 3) {
                    const ownedTerritories = this.territoryData.filter(t => t.owned).length;
                    this.stage3Resources.food = Math.min(
                        this.stage3Resources.food + ownedTerritories * 0.5 * dt,
                        this.stage3Caps.food
                    );
                    
                    const breedingBonus = this.stage3Resources.breedingPoints * 0.1;
                    this.swarmSize += breedingBonus * dt;
                }
            }
            
            updateFacilities(dt) {
                this.facilities.forEach(facility => {
                    const type = facility.type;
                    const config = this.getFacilityConfig(type);
                    
                    if (config && config.output) {
                        // äº§å‡ºèµ„æº
                        for (const [resource, rate] of Object.entries(config.output)) {
                            if (resource === 'defense') continue;
                            
                            const amount = rate * facility.level * dt;
                            
                            if (this.stage === 1) {
                                if (this.resources[resource] !== undefined) {
                                    this.resources[resource] = Math.min(
                                        this.resources[resource] + amount,
                                        this.resourceCaps[resource] || Infinity
                                    );
                                }
                            } else if (this.stage === 2) {
                                if (resource === 'signals') {
                                    this.stage2Resources.signals = Math.min(
                                        this.stage2Resources.signals + amount,
                                        this.stage2Caps.signals
                                    );
                                } else if (this.resources[resource] !== undefined) {
                                    this.resources[resource] = Math.min(
                                        this.resources[resource] + amount,
                                        this.resourceCaps[resource] || Infinity
                                    );
                                }
                            } else if (this.stage === 3) {
                                if (this.stage3Resources[resource] !== undefined) {
                                    this.stage3Resources[resource] = Math.min(
                                        this.stage3Resources[resource] + amount,
                                        this.stage3Caps[resource] || Infinity
                                    );
                                }
                            }
                        }
                    }
                    
                    // æ›´æ–°åŠ¨ç”»
                    facility.animationTime = (facility.animationTime || 0) + dt;
                });
            }
            
            updateStage2(dt) {
                // æ£€æŸ¥å™¨å®˜å½¢æˆ
                this.checkOrgans();
            }
            
            updateStage3(dt) {
                // é±¼ç¾¤ç§»åŠ¨
                // ç®€åŒ–å¤„ç†ï¼Œåœ¨æ¸²æŸ“æ—¶æ›´æ–°
            }
            
            checkOrgans() {
                let changed = false;
                
                // æ£€æŸ¥å¿ƒè„
                if (!this.organs.heart.formed &&
                    this.stage2Resources.muscleFibers >= this.organs.heart.required.muscle &&
                    this.stage2Resources.nerveNodes >= this.organs.heart.required.nerve) {
                    this.organs.heart.formed = true;
                    changed = true;
                    this.showFloatingText(this.canvas.width / 2, this.canvas.height / 2, 'â¤ï¸ å¿ƒè„å½¢æˆ!', '#ff4444');
                }
                
                // æ£€æŸ¥å¤§è„‘
                if (!this.organs.brain.formed &&
                    this.stage2Resources.nerveNodes >= this.organs.brain.required.nerve &&
                    this.stage2Resources.muscleFibers >= this.organs.brain.required.muscle) {
                    this.organs.brain.formed = true;
                    changed = true;
                    this.showFloatingText(this.canvas.width / 2, this.canvas.height / 2, 'ğŸ§  å¤§è„‘å½¢æˆ!', '#8844ff');
                }
                
                // æ£€æŸ¥æ¶ˆåŒ–ç³»ç»Ÿ
                if (!this.organs.digestive.formed &&
                    this.stage2Resources.digestiveGlands >= this.organs.digestive.required.digestive &&
                    this.stage2Resources.muscleFibers >= this.organs.digestive.required.muscle) {
                    this.organs.digestive.formed = true;
                    changed = true;
                    this.showFloatingText(this.canvas.width / 2, this.canvas.height / 2, 'ğŸ½ï¸ æ¶ˆåŒ–ç³»ç»Ÿå½¢æˆ!', '#44ff44');
                }
                
                if (changed) {
                    this.updateOrganHint();
                }
            }
            
            updateParticles(dt) {
                this.particles = this.particles.filter(p => {
                    p.x += p.vx * dt;
                    p.y += p.vy * dt;
                    p.life -= dt;
                    p.alpha = p.life / p.maxLife;
                    return p.life > 0;
                });
            }
            
            // ==================== æ¸²æŸ“ ====================
            render() {
                // æ¸…ç©ºç”»å¸ƒ
                this.ctx.fillStyle = '#0a1628';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                this.ctx.save();
                
                // åº”ç”¨ç›¸æœºå˜æ¢
                this.ctx.translate(-this.camera.x, -this.camera.y);
                
                // æ¸²æŸ“åœ°å›¾èƒŒæ™¯
                this.renderMapBackground();
                
                // æ¸²æŸ“ç”Ÿæ€åŒºåŸŸ
                this.renderZones();
                
                // æ¸²æŸ“è®¾æ–½
                this.renderFacilities();
                
                // æ¸²æŸ“ç©å®¶
                this.renderPlayer();
                
                // æ¸²æŸ“ç²’å­
                this.renderParticles();
                
                this.ctx.restore();
            }
            
            renderMapBackground() {
                // ç½‘æ ¼èƒŒæ™¯
                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.03)';
                this.ctx.lineWidth = 1;
                
                const gridSize = 50;
                for (let x = 0; x <= this.mapWidth; x += gridSize) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, 0);
                    this.ctx.lineTo(x, this.mapHeight);
                    this.ctx.stroke();
                }
                for (let y = 0; y <= this.mapHeight; y += gridSize) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, y);
                    this.ctx.lineTo(this.mapWidth, y);
                    this.ctx.stroke();
                }
                
                // åœ°å›¾è¾¹ç•Œ
                this.ctx.strokeStyle = 'rgba(0, 255, 255, 0.2)';
                this.ctx.lineWidth = 3;
                this.ctx.strokeRect(0, 0, this.mapWidth, this.mapHeight);
            }
            
            renderZones() {
                this.zones.forEach(zone => {
                    // åŒºåŸŸå…‰æ™•
                    const gradient = this.ctx.createRadialGradient(
                        zone.x, zone.y, 0,
                        zone.x, zone.y, zone.radius
                    );
                    gradient.addColorStop(0, zone.color);
                    gradient.addColorStop(1, 'transparent');
                    
                    this.ctx.fillStyle = gradient;
                    this.ctx.beginPath();
                    this.ctx.arc(zone.x, zone.y, zone.radius, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    // åŒºåŸŸè¾¹ç•Œ
                    this.ctx.strokeStyle = zone.color.replace('0.15', '0.4');
                    this.ctx.lineWidth = 2;
                    this.ctx.setLineDash([10, 10]);
                    this.ctx.beginPath();
                    this.ctx.arc(zone.x, zone.y, zone.radius, 0, Math.PI * 2);
                    this.ctx.stroke();
                    this.ctx.setLineDash([]);
                    
                    // åŒºåŸŸå›¾æ ‡
                    this.ctx.font = '24px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    const icon = zone.type === 'nutrient' ? 'ğŸŒ¿' : 'â˜ ï¸';
                    this.ctx.fillText(icon, zone.x, zone.y);
                });
            }
            
            renderFacilities() {
                this.facilities.forEach(facility => {
                    const config = this.getFacilityConfig(facility.type);
                    if (!config) return;
                    
                    const x = facility.x;
                    const y = facility.y;
                    const size = 25;
                    
                    // è®¾æ–½å…‰æ™•
                    const pulse = Math.sin((facility.animationTime || 0) * 3) * 0.2 + 0.8;
                    const gradient = this.ctx.createRadialGradient(
                        x, y, 0,
                        x, y, size * 2 * pulse
                    );
                    gradient.addColorStop(0, config.color + '60');
                    gradient.addColorStop(1, 'transparent');
                    
                    this.ctx.fillStyle = gradient;
                    this.ctx.beginPath();
                    this.ctx.arc(x, y, size * 2 * pulse, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    // è®¾æ–½åº•åº§
                    this.ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    this.ctx.beginPath();
                    this.ctx.arc(x, y, size, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    // è®¾æ–½è¾¹æ¡†
                    this.ctx.strokeStyle = config.color;
                    this.ctx.lineWidth = 2;
                    this.ctx.beginPath();
                    this.ctx.arc(x, y, size, 0, Math.PI * 2);
                    this.ctx.stroke();
                    
                    // è®¾æ–½å›¾æ ‡
                    this.ctx.font = '20px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    this.ctx.fillText(config.icon, x, y);
                    
                    // ç­‰çº§æ ‡è®°
                    if (facility.level > 1) {
                        this.ctx.fillStyle = config.color;
                        this.ctx.font = 'bold 12px Arial';
                        this.ctx.fillText('Lv.' + facility.level, x, y + size + 15);
                    }
                });
            }
            
            renderPlayer() {
                const x = this.player.x;
                const y = this.player.y;
                const r = this.player.radius;
                
                // ç©å®¶å…‰æ™•
                const gradient = this.ctx.createRadialGradient(x, y, 0, x, y, r * 3);
                gradient.addColorStop(0, 'rgba(0, 255, 255, 0.3)');
                gradient.addColorStop(1, 'transparent');
                
                this.ctx.fillStyle = gradient;
                this.ctx.beginPath();
                this.ctx.arc(x, y, r * 3, 0, Math.PI * 2);
                this.ctx.fill();
                
                // ç©å®¶ä¸»ä½“
                this.ctx.fillStyle = 'rgba(0, 200, 200, 0.8)';
                this.ctx.beginPath();
                this.ctx.arc(x, y, r, 0, Math.PI * 2);
                this.ctx.fill();
                
                // ç©å®¶è¾¹æ¡†
                this.ctx.strokeStyle = '#00ffff';
                this.ctx.lineWidth = 2;
                this.ctx.beginPath();
                this.ctx.arc(x, y, r, 0, Math.PI * 2);
                this.ctx.stroke();
                
                // ç»†èƒæ ¸
                this.ctx.fillStyle = 'rgba(0, 100, 150, 0.9)';
                this.ctx.beginPath();
                this.ctx.arc(x, y, r * 0.4, 0, Math.PI * 2);
                this.ctx.fill();
                
                // çº¤æ¯›åŠ¨ç”»
                const time = Date.now() / 1000;
                for (let i = 0; i < 8; i++) {
                    const angle = time + (i * Math.PI * 2 / 8);
                    const x1 = x + Math.cos(angle) * r;
                    const y1 = y + Math.sin(angle) * r;
                    const x2 = x + Math.cos(angle) * (r + 8);
                    const y2 = y + Math.sin(angle) * (r + 8);
                    
                    this.ctx.beginPath();
                    this.ctx.moveTo(x1, y1);
                    this.ctx.lineTo(x2, y2);
                    this.ctx.strokeStyle = 'rgba(0, 255, 200, 0.6)';
                    this.ctx.lineWidth = 2;
                    this.ctx.stroke();
                }
            }
            
            renderParticles() {
                this.particles.forEach(p => {
                    this.ctx.globalAlpha = p.alpha;
                    this.ctx.fillStyle = p.color;
                    this.ctx.beginPath();
                    this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    this.ctx.fill();
                });
                this.ctx.globalAlpha = 1;
            }
            
            // ==================== è®¾æ–½ç®¡ç† ====================
            deployFacility(type) {
                const config = this.getFacilityConfig(type);
                if (!config) return;
                
                // æ£€æŸ¥è®¾æ–½æ•°é‡ä¸Šé™
                const maxFacilities = this.stage === 1 ? this.resources.cells : 
                                     this.stage === 2 ? (this.resources.cells + this.stage2Resources.nerveNodes + this.stage2Resources.muscleFibers + this.stage2Resources.digestiveGlands) :
                                     Math.floor(this.swarmSize);
                
                if (this.facilities.length >= maxFacilities) {
                    this.showFloatingText(this.canvas.width / 2, this.canvas.height / 2, 'è®¾æ–½æ•°é‡å·²è¾¾ä¸Šé™!', '#ff5555');
                    return;
                }
                
                // æ£€æŸ¥èµ„æº
                let canAfford = true;
                for (const [resource, cost] of Object.entries(config.cost)) {
                    let current = 0;
                    if (this.stage === 1) {
                        current = this.resources[resource] || 0;
                    } else if (this.stage === 2) {
                        current = this.resources[resource] || this.stage2Resources[resource] || 0;
                    } else if (this.stage === 3) {
                        current = this.stage3Resources[resource] || 0;
                    }
                    if (current < cost) {
                        canAfford = false;
                        break;
                    }
                }
                
                if (!canAfford) {
                    this.showFloatingText(this.canvas.width / 2, this.canvas.height / 2, 'èµ„æºä¸è¶³!', '#ff5555');
                    return;
                }
                
                // æ‰£é™¤èµ„æº
                for (const [resource, cost] of Object.entries(config.cost)) {
                    if (this.stage === 1) {
                        this.resources[resource] -= cost;
                    } else if (this.stage === 2) {
                        if (this.resources[resource] !== undefined) {
                            this.resources[resource] -= cost;
                        }
                    } else if (this.stage === 3) {
                        this.stage3Resources[resource] -= cost;
                    }
                }
                
                // åˆ›å»ºè®¾æ–½
                const facility = {
                    id: Date.now() + Math.random(),
                    type: type,
                    x: this.player.x,
                    y: this.player.y,
                    level: 1,
                    animationTime: 0
                };
                
                this.facilities.push(facility);
                
                // é˜¶æ®µ2ç‰¹æ®Šå¤„ç†
                if (this.stage === 2) {
                    if (type === 'nerve') this.stage2Resources.nerveNodes++;
                    if (type === 'muscle') this.stage2Resources.muscleFibers++;
                    if (type === 'digestive') this.stage2Resources.digestiveGlands++;
                }
                
                // é˜¶æ®µ3ç‰¹æ®Šå¤„ç†
                if (this.stage === 3) {
                    if (type === 'territory') {
                        this.territoryData.push({
                            x: this.player.x,
                            y: this.player.y,
                            owned: true
                        });
                        this.stage3Resources.territories++;
                    }
                    if (type === 'patrol') this.stage3Resources.patrols++;
                    if (type === 'breeding') this.stage3Resources.breedingPoints++;
                }
                
                // è§†è§‰æ•ˆæœ
                this.spawnParticles(this.player.x, this.player.y, 10, config.color);
                this.showFloatingText(this.player.x - this.camera.x, this.player.y - this.camera.y, `+${config.name}`, config.color);
                
                this.updateUI();
            }
            
            upgradeFacility(id) {
                const facility = this.facilities.find(f => f.id === id);
                if (!facility) return;
                
                const config = this.getFacilityConfig(facility.type);
                const upgradeCost = Math.floor(Object.values(config.cost)[0] * Math.pow(1.5, facility.level - 1));
                const costType = Object.keys(config.cost)[0];
                
                let currentResource = 0;
                if (this.stage === 1) {
                    currentResource = this.resources[costType] || 0;
                } else if (this.stage === 2) {
                    currentResource = this.resources[costType] || 0;
                } else if (this.stage === 3) {
                    currentResource = this.stage3Resources[costType] || 0;
                }
                
                if (currentResource >= upgradeCost) {
                    if (this.stage === 1) {
                        this.resources[costType] -= upgradeCost;
                    } else if (this.stage === 2) {
                        this.resources[costType] -= upgradeCost;
                    } else if (this.stage === 3) {
                        this.stage3Resources[costType] -= upgradeCost;
                    }
                    
                    facility.level++;
                    this.spawnParticles(facility.x, facility.y, 8, '#ffff00');
                    this.updateUI();
                }
            }
            
            removeFacility(id) {
                const index = this.facilities.findIndex(f => f.id === id);
                if (index === -1) return;
                
                const facility = this.facilities[index];
                
                // é˜¶æ®µ2ç‰¹æ®Šå¤„ç†
                if (this.stage === 2) {
                    if (facility.type === 'nerve') this.stage2Resources.nerveNodes--;
                    if (facility.type === 'muscle') this.stage2Resources.muscleFibers--;
                    if (facility.type === 'digestive') this.stage2Resources.digestiveGlands--;
                }
                
                // é˜¶æ®µ3ç‰¹æ®Šå¤„ç†
                if (this.stage === 3) {
                    if (facility.type === 'territory') {
                        this.territoryData = this.territoryData.filter(t => 
                            Math.abs(t.x - facility.x) > 10 || Math.abs(t.y - facility.y) > 10
                        );
                        this.stage3Resources.territories--;
                    }
                    if (facility.type === 'patrol') this.stage3Resources.patrols--;
                    if (facility.type === 'breeding') this.stage3Resources.breedingPoints--;
                }
                
                this.spawnParticles(facility.x, facility.y, 5, '#ff5555');
                this.facilities.splice(index, 1);
                this.updateUI();
            }
            
            getFacilityConfig(type) {
                if (this.stage === 1) {
                    return this.facilityTypes[type];
                } else if (this.stage === 2) {
                    return this.stage2Facilities[type];
                } else if (this.stage === 3) {
                    return this.stage3Facilities[type];
                }
                return null;
            }
            
            getAvailableFacilities() {
                if (this.currentZone === 'danger') return [];
                
                if (this.stage === 1) {
                    return this.currentZone === 'nutrient' ? ['cilia', 'metabolism', 'membrane'] : [];
                } else if (this.stage === 2) {
                    return ['nerve', 'muscle', 'digestive'];
                } else if (this.stage === 3) {
                    return ['territory', 'patrol', 'breeding'];
                }
                return [];
            }
            
            // ==================== è¿›åŒ–ç³»ç»Ÿ ====================
            checkEvolution() {
                let progress = 0;
                let canEvolve = false;
                
                if (this.stage === 1) {
                    const energyProgress = Math.min(this.resources.energy / 100, 1);
                    const cellProgress = Math.min(this.resources.cells / 5, 1);
                    progress = (energyProgress + cellProgress) / 2 * 100;
                    canEvolve = this.resources.energy >= 100 && this.resources.cells >= 5;
                } else if (this.stage === 2) {
                    const organsFormed = Object.values(this.organs).filter(o => o.formed).length;
                    const organProgress = organsFormed / 3;
                    const signalProgress = Math.min(this.stage2Resources.signals / 30, 1);
                    progress = (organProgress + signalProgress) / 2 * 100;
                    canEvolve = organsFormed >= 2 && this.stage2Resources.signals >= 30;
                } else if (this.stage === 3) {
                    const territoryProgress = Math.min(this.stage3Resources.territories / 3, 1);
                    const swarmProgress = Math.min(this.swarmSize / 30, 1);
                    progress = (territoryProgress + swarmProgress) / 2 * 100;
                    canEvolve = this.stage3Resources.territories >= 3 && this.swarmSize >= 30;
                }
                
                document.getElementById('evolutionFill').style.width = progress + '%';
                document.getElementById('evolutionPercent').textContent = Math.floor(progress) + '%';
                
                const evolveBtn = document.getElementById('evolveBtn');
                if (canEvolve) {
                    evolveBtn.classList.add('active');
                } else {
                    evolveBtn.classList.remove('active');
                }
            }
            
            attemptEvolution() {
                let canEvolve = false;
                
                if (this.stage === 1) {
                    canEvolve = this.resources.energy >= 100 && this.resources.cells >= 5;
                } else if (this.stage === 2) {
                    const organsFormed = Object.values(this.organs).filter(o => o.formed).length;
                    canEvolve = organsFormed >= 2 && this.stage2Resources.signals >= 30;
                } else if (this.stage === 3) {
                    canEvolve = this.stage3Resources.territories >= 3 && this.swarmSize >= 30;
                }
                
                if (canEvolve) {
                    this.evolve();
                }
            }
            
            evolve() {
                this.stage++;
                
                // æ¸…ç†æ—§è®¾æ–½
                this.facilities = [];
                
                if (this.stage === 2) {
                    // é˜¶æ®µ2åˆå§‹åŒ–
                    this.resources.cells = Math.max(1, this.resources.cells);
                    this.showFloatingText(this.canvas.width / 2, this.canvas.height / 2, 'ğŸ§¬ è¿›å…¥å¤šç»†èƒé˜¶æ®µ!', '#8844ff');
                } else if (this.stage === 3) {
                    // é˜¶æ®µ3åˆå§‹åŒ–
                    this.swarmSize = this.resources.cells + this.stage2Resources.nerveNodes + this.stage2Resources.muscleFibers + this.stage2Resources.digestiveGlands;
                    this.showFloatingText(this.canvas.width / 2, this.canvas.height / 2, 'ğŸŸ è¿›å…¥æµ·æ´‹ç”Ÿç‰©é˜¶æ®µ!', '#00aaff');
                } else if (this.stage === 4) {
                    alert('ğŸ‰ æ­å–œï¼ä½ å·²å®Œæˆæ‰€æœ‰é˜¶æ®µï¼');
                    this.stage = 3;
                    return;
                }
                
                this.updateStageUI();
                this.updateUI();
                this.saveGame();
            }
            
            // ==================== UIæ›´æ–° ====================
            secondUpdate() {
                this.playTime++;
                this.updateUI();
            }
            
            updateUI() {
                this.updateResourcesBar();
                this.updateFacilityList();
                this.updateDeployMenu();
            }
            
            updateStageUI() {
                const stageNames = {
                    1: 'é˜¶æ®µ1: å•ç»†èƒ',
                    2: 'é˜¶æ®µ2: å¤šç»†èƒ',
                    3: 'é˜¶æ®µ3: æµ·æ´‹ç”Ÿç‰©'
                };
                document.getElementById('stageBadge').textContent = stageNames[this.stage] || 'æœªçŸ¥é˜¶æ®µ';
                
                // æ›´æ–°å™¨å®˜æç¤ºæ˜¾ç¤º
                document.getElementById('organHint').style.display = this.stage === 2 ? 'block' : 'none';
                if (this.stage === 2) {
                    this.updateOrganHint();
                }
            }
            
            updateOrganHint() {
                const organList = document.getElementById('organList');
                let html = '';
                
                if (this.organs.heart.formed) {
                    html += '<span class="organ-tag formed">â¤ï¸ å¿ƒè„</span>';
                } else {
                    html += `<span class="organ-tag">â¤ï¸ å¿ƒè„ (${this.stage2Resources.muscleFibers}/${this.organs.heart.required.muscle}è‚Œè‚‰, ${this.stage2Resources.nerveNodes}/${this.organs.heart.required.nerve}ç¥ç»)</span>`;
                }
                
                if (this.organs.brain.formed) {
                    html += '<span class="organ-tag formed">ğŸ§  å¤§è„‘</span>';
                } else {
                    html += `<span class="organ-tag">ğŸ§  å¤§è„‘ (${this.stage2Resources.nerveNodes}/${this.organs.brain.required.nerve}ç¥ç», ${this.stage2Resources.muscleFibers}/${this.organs.brain.required.muscle}è‚Œè‚‰)</span>`;
                }
                
                if (this.organs.digestive.formed) {
                    html += '<span class="organ-tag formed">ğŸ½ï¸ æ¶ˆåŒ–ç³»ç»Ÿ</span>';
                } else {
                    html += `<span class="organ-tag">ğŸ½ï¸ æ¶ˆåŒ– (${this.stage2Resources.digestiveGlands}/${this.organs.digestive.required.digestive}è…ºä½“, ${this.stage2Resources.muscleFibers}/${this.organs.digestive.required.muscle}è‚Œè‚‰)</span>`;
                }
                
                organList.innerHTML = html;
            }
            
            updateResourcesBar() {
                const bar = document.getElementById('resourcesBar');
                let html = '';
                
                if (this.stage === 1) {
                    html += `<div class="resource-mini">ğŸƒ <span class="value">${Math.floor(this.resources.nutrients)}</span></div>`;
                    html += `<div class="resource-mini">âš¡ <span class="value">${Math.floor(this.resources.energy)}</span></div>`;
                    html += `<div class="resource-mini">ğŸ”¬ <span class="value">${this.resources.cells}</span></div>`;
                } else if (this.stage === 2) {
                    html += `<div class="resource-mini">ğŸƒ <span class="value">${Math.floor(this.resources.nutrients)}</span></div>`;
                    html += `<div class="resource-mini">âš¡ <span class="value">${Math.floor(this.resources.energy)}</span></div>`;
                    html += `<div class="resource-mini">ğŸ“¡ <span class="value">${Math.floor(this.stage2Resources.signals)}</span></div>`;
                } else if (this.stage === 3) {
                    html += `<div class="resource-mini">ğŸŸ <span class="value">${Math.floor(this.stage3Resources.food)}</span></div>`;
                    html += `<div class="resource-mini">ğŸŒŠ <span class="value">${Math.floor(this.stage3Resources.swarmPoints)}</span></div>`;
                    html += `<div class="resource-mini">ğŸ‘¥ <span class="value">${Math.floor(this.swarmSize)}</span></div>`;
                }
                
                bar.innerHTML = html;
                
                // ç§»åŠ¨ç«¯èµ„æºæ¡
                document.getElementById('mobileResources').innerHTML = html;
            }
            
            updateFacilityList() {
                const list = document.getElementById('facilityList');
                const maxFacilities = this.stage === 1 ? this.resources.cells : 
                                     this.stage === 2 ? (this.resources.cells + this.stage2Resources.nerveNodes + this.stage2Resources.muscleFibers + this.stage2Resources.digestiveGlands) :
                                     Math.floor(this.swarmSize);
                
                document.getElementById('facilityCount').textContent = this.facilities.length;
                document.getElementById('maxFacilityCount').textContent = maxFacilities;
                
                let html = '';
                
                if (this.facilities.length === 0) {
                    html = '<div style="text-align: center; color: rgba(255,255,255,0.4); padding: 30px;">æš‚æ— è®¾æ–½<br>ç§»åŠ¨åˆ°è¥å…»åŒºéƒ¨ç½²</div>';
                } else {
                    this.facilities.forEach(facility => {
                        const config = this.getFacilityConfig(facility.type);
                        if (!config) return;
                        
                        // è®¡ç®—å‡çº§æˆæœ¬
                        const upgradeCost = Math.floor(Object.values(config.cost)[0] * Math.pow(1.5, facility.level - 1));
                        const costType = Object.keys(config.cost)[0];
                        
                        let currentResource = 0;
                        if (this.stage === 1) {
                            currentResource = this.resources[costType] || 0;
                        } else if (this.stage === 2) {
                            currentResource = this.resources[costType] || 0;
                        } else if (this.stage === 3) {
                            currentResource = this.stage3Resources[costType] || 0;
                        }
                        
                        const canUpgrade = currentResource >= upgradeCost;
                        
                        html += `
                            <div class="facility-item">
                                <div class="facility-header">
                                    <div class="facility-name">
                                        <span>${config.icon}</span>
                                        <span>${config.name}</span>
                                    </div>
                                    <span class="facility-level">Lv.${facility.level}</span>
                                </div>
                                <div class="facility-output">${config.description}</div>
                                <div class="facility-actions">
                                    <button class="facility-btn btn-upgrade" ${canUpgrade ? '' : 'disabled'} 
                                            onclick="game.upgradeFacility(${facility.id})">
                                        å‡çº§ (${upgradeCost})
                                    </button>
                                    <button class="facility-btn btn-remove" onclick="game.removeFacility(${facility.id})">
                                        æ‹†é™¤
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                }
                
                list.innerHTML = html;
            }
            
            updateDeployMenu() {
                const menu = document.getElementById('deployMenu');
                const options = document.getElementById('deployOptions');
                
                const available = this.getAvailableFacilities();
                
                if (available.length === 0) {
                    menu.classList.remove('visible');
                    return;
                }
                
                menu.classList.add('visible');
                
                let html = '';
                available.forEach(type => {
                    const config = this.getFacilityConfig(type);
                    if (!config) return;
                    
                    // æ£€æŸ¥èµ„æº
                    let canAfford = true;
                    let costText = '';
                    
                    for (const [resource, cost] of Object.entries(config.cost)) {
                        let current = 0;
                        if (this.stage === 1) {
                            current = this.resources[resource] || 0;
                        } else if (this.stage === 2) {
                            current = this.resources[resource] || 0;
                        } else if (this.stage === 3) {
                            current = this.stage3Resources[resource] || 0;
                        }
                        
                        if (current < cost) canAfford = false;
                        
                        const resourceName = {
                            nutrients: 'è¥å…»',
                            energy: 'èƒ½é‡',
                            swarmPoints: 'ç¾¤ä½“ç‚¹',
                            food: 'é£Ÿç‰©'
                        }[resource] || resource;
                        
                        costText += `${cost}${resourceName} `;
                    }
                    
                    html += `
                        <div class="deploy-card ${canAfford ? '' : 'disabled'}" onclick="${canAfford ? `game.deployFacility('${type}')` : ''}">
                            <div class="deploy-icon">${config.icon}</div>
                            <div class="deploy-name">${config.name}</div>
                            <div class="deploy-cost ${canAfford ? '' : 'cannot-afford'}">${costText}</div>
                        </div>
                    `;
                });
                
                options.innerHTML = html;
            }
            
            updateZoneIndicator() {
                const indicator = document.getElementById('zoneIndicator');
                const zoneNames = {
                    normal: 'ğŸ“ æ™®é€šåŒºåŸŸ',
                    nutrient: 'ğŸŒ¿ è¥å…»åŒº',
                    danger: 'â˜ ï¸ å±é™©åŒº'
                };
                
                indicator.textContent = zoneNames[this.currentZone] || 'ğŸ“ æ™®é€šåŒºåŸŸ';
                indicator.className = 'zone-indicator ' + this.currentZone;
            }
            
            // ==================== è§†è§‰æ•ˆæœ ====================
            spawnParticles(x, y, count, color) {
                for (let i = 0; i < count; i++) {
                    const angle = (Math.PI * 2 * i) / count;
                    const speed = 30 + Math.random() * 40;
                    this.particles.push({
                        x: x,
                        y: y,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed,
                        life: 0.5 + Math.random() * 0.5,
                        maxLife: 1,
                        alpha: 1,
                        size: 2 + Math.random() * 3,
                        color: color
                    });
                }
            }
            
            showFloatingText(x, y, text, color) {
                const element = document.createElement('div');
                element.className = 'floating-text';
                element.textContent = text;
                element.style.left = x + 'px';
                element.style.top = y + 'px';
                element.style.color = color;
                document.getElementById('canvasContainer').appendChild(element);
                
                setTimeout(() => element.remove(), 1200);
            }
            
            // ==================== å­˜æ¡£ç³»ç»Ÿ ====================
            saveGame() {
                const saveData = {
                    stage: this.stage,
                    playTime: this.playTime,
                    player: { x: this.player.x, y: this.player.y },
                    resources: this.resources,
                    resourceCaps: this.resourceCaps,
                    stage2Resources: this.stage2Resources,
                    stage2Caps: this.stage2Caps,
                    stage3Resources: this.stage3Resources,
                    stage3Caps: this.stage3Caps,
                    facilities: this.facilities,
                    organs: this.organs,
                    territoryData: this.territoryData,
                    swarmSize: this.swarmSize,
                    zones: this.zones
                };
                
                localStorage.setItem('evolutionGameSave_v2', JSON.stringify(saveData));
                this.showFloatingText(this.canvas.width / 2, this.canvas.height - 100, 'ğŸ’¾ å·²ä¿å­˜', '#00ff88');
            }
            
            loadGame() {
                const saveString = localStorage.getItem('evolutionGameSave_v2');
                if (!saveString) return;
                
                try {
                    const saveData = JSON.parse(saveString);
                    
                    this.stage = saveData.stage || 1;
                    this.playTime = saveData.playTime || 0;
                    
                    if (saveData.player) {
                        this.player.x = saveData.player.x;
                        this.player.y = saveData.player.y;
                    }
                    
                    this.resources = { ...this.resources, ...saveData.resources };
                    this.resourceCaps = { ...this.resourceCaps, ...saveData.resourceCaps };
                    this.stage2Resources = { ...this.stage2Resources, ...saveData.stage2Resources };
                    this.stage2Caps = { ...this.stage2Caps, ...saveData.stage2Caps };
                    this.stage3Resources = { ...this.stage3Resources, ...saveData.stage3Resources };
                    this.stage3Caps = { ...this.stage3Caps, ...saveData.stage3Caps };
                    this.facilities = saveData.facilities || [];
                    this.organs = saveData.organs || this.organs;
                    this.territoryData = saveData.territoryData || [];
                    this.swarmSize = saveData.swarmSize || 1;
                    
                    if (saveData.zones) {
                        this.zones = saveData.zones;
                    }
                    
                    this.updateCamera();
                    this.updateStageUI();
                    this.updateUI();
                } catch (e) {
                    console.error('åŠ è½½å­˜æ¡£å¤±è´¥:', e);
                }
            }
            
            hardReset() {
                if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è¿›åº¦å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                    localStorage.removeItem('evolutionGameSave_v2');
                    location.reload();
                }
            }
        }
        
        // å¯åŠ¨æ¸¸æˆ
        const game = new EvolutionGame();
    </script>
</body>
</html>
