<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>è¿›åŒ–çºªå…ƒ v3</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a1628;
            height: 100vh;
            width: 100vw;
            color: #fff;
            overflow: hidden;
            touch-action: none;
        }
        .game-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .top-bar {
            height: 50px;
            background: rgba(10, 22, 40, 0.95);
            border-bottom: 1px solid rgba(0, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 100;
        }
        .stage-badge {
            padding: 4px 10px;
            background: linear-gradient(135deg, rgba(0, 200, 200, 0.3), rgba(0, 150, 255, 0.3));
            border-radius: 12px;
            font-size: 13px;
        }
        .resource-display {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: bold;
        }
        .resource-display .rate {
            font-size: 11px;
            color: #00ff88;
        }
        /* æ¸¸æˆåŒºåŸŸ */
        .game-area {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        /* éƒ¨ç½²æŒ‰é’® */
        .deploy-buttons {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 90;
            background: rgba(10, 22, 40, 0.9);
            padding: 10px;
            border-radius: 16px;
            border: 1px solid rgba(0, 255, 255, 0.2);
        }
        .deploy-btn {
            width: 65px;
            height: 65px;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            font-size: 11px;
        }
        .deploy-btn:disabled {
            opacity: 0.3;
        }
        .deploy-btn .icon { font-size: 22px; }
        .deploy-btn .output { color: #00ff88; font-size: 10px; }
        /* çŠ¶æ€æç¤º */
        .status-hint {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 95;
        }
        .status-hint.in-zone {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        .status-hint.out-zone {
            background: rgba(255, 85, 85, 0.2);
            color: #ff8888;
        }
        /* è®¾æ–½åˆ—è¡¨ */
        .facility-list {
            position: fixed;
            top: 100px;
            right: 10px;
            width: 130px;
            max-height: 35vh;
            overflow-y: auto;
            background: rgba(10, 22, 40, 0.9);
            border-radius: 12px;
            padding: 10px;
            z-index: 90;
            font-size: 11px;
        }
        .facility-item {
            display: flex;
            justify-content: space-between;
            padding: 6px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            margin-bottom: 4px;
        }
        .mini-btn {
            width: 22px;
            height: 22px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
        }
        /* è¿›åŒ–æŒ‰é’® */
        .evolve-btn {
            position: fixed;
            top: 100px;
            left: 10px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #ff00ff, #8800ff);
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            z-index: 90;
            display: none;
        }
        .evolve-btn.visible { display: block; }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="top-bar">
            <div class="stage-badge" id="stageBadge">å•ç»†èƒ (1/3)</div>
            <div class="resource-display">
                <span>âœ¨ <span id="evolutionPoints">50</span></span>
                <span class="rate" id="evolutionRate">+0/s</span>
            </div>
        </div>
        
        <div class="game-area">
            <canvas id="gameCanvas"></canvas>
        </div>
        
        <div class="status-hint out-zone" id="statusHint">ç§»åŠ¨åˆ°ç»¿è‰²åŒºåŸŸéƒ¨ç½²</div>
        
        <div class="deploy-buttons">
            <button class="deploy-btn" id="btn-basic" onclick="deploy('basic')">
                <span class="icon">ğŸ”µ</span>
                <span>5</span>
                <span class="output">+0.5</span>
            </button>
            <button class="deploy-btn" id="btn-collector" onclick="deploy('collector')">
                <span class="icon">ğŸŒŠ</span>
                <span>10</span>
                <span class="output">+1</span>
            </button>
            <button class="deploy-btn" id="btn-booster" onclick="deploy('booster')">
                <span class="icon">âš¡</span>
                <span>25</span>
                <span class="output">+3</span>
            </button>
        </div>
        
        <button class="evolve-btn" id="evolveBtn" onclick="evolve()">ğŸ§¬</button>
        
        <div class="facility-list">
            <div style="text-align:center;margin-bottom:8px;">å·²éƒ¨ç½²: <span id="deployedCount">0</span>/<span id="deployLimit">5</span></div>
            <div id="facilityList"></div>
        </div>
    </div>

    <script>
        const WORLD_SIZE = 2000;
        
        const game = {
            stage: 1,
            points: 50,
            rate: 0,
            deployed: [],
            limit: 5,
            player: { x: WORLD_SIZE/2, y: WORLD_SIZE/2, tx: null, ty: null },
            cam: { x: 0, y: 0 },
            zones: [],
            keys: {}
        };

        const facilities = {
            basic: { name: 'åŸºç¡€', icon: 'ğŸ”µ', cost: 5, out: 0.5 },
            collector: { name: 'æ”¶é›†', icon: 'ğŸŒŠ', cost: 10, out: 1 },
            booster: { name: 'åŠ é€Ÿ', icon: 'âš¡', cost: 25, out: 3 }
        };

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }

        function initZones() {
            game.zones = [];
            // ç©å®¶å‘¨å›´3ä¸ª
            for (let i = 0; i < 3; i++) {
                const a = (Math.PI * 2 / 3) * i;
                game.zones.push({
                    x: game.player.x + Math.cos(a) * 120,
                    y: game.player.y + Math.sin(a) * 120,
                    r: 70
                });
            }
            // éšæœº15ä¸ª
            for (let i = 0; i < 15; i++) {
                game.zones.push({
                    x: 100 + Math.random() * (WORLD_SIZE - 200),
                    y: 100 + Math.random() * (WORLD_SIZE - 200),
                    r: 50 + Math.random() * 30
                });
            }
        }

        function toScreen(wx, wy) {
            return { x: wx - game.cam.x, y: wy - game.cam.y };
        }

        function inZone() {
            return game.zones.some(z => {
                const dx = game.player.x - z.x;
                const dy = game.player.y - z.y;
                return Math.sqrt(dx*dx + dy*dy) < z.r;
            });
        }

        function render() {
            // ç›¸æœºè·Ÿéšç©å®¶
            game.cam.x = game.player.x - canvas.width/2;
            game.cam.y = game.player.y - canvas.height/2;

            // èƒŒæ™¯
            ctx.fillStyle = '#0a1628';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç½‘æ ¼
            ctx.strokeStyle = 'rgba(0,255,255,0.05)';
            ctx.lineWidth = 1;
            const gs = 100;
            const ox = -game.cam.x % gs;
            const oy = -game.cam.y % gs;
            for (let x = ox; x < canvas.width; x += gs) {
                ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke();
            }
            for (let y = oy; y < canvas.height; y += gs) {
                ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke();
            }

            // è¾¹ç•Œ
            const tl = toScreen(0, 0);
            const br = toScreen(WORLD_SIZE, WORLD_SIZE);
            ctx.strokeStyle = 'rgba(0,255,255,0.3)';
            ctx.lineWidth = 2;
            ctx.strokeRect(tl.x, tl.y, br.x-tl.x, br.y-tl.y);

            // èµ„æºåŒº
            game.zones.forEach((z, i) => {
                const p = toScreen(z.x, z.y);
                const initial = i < 3;
                
                const grad = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, z.r);
                grad.addColorStop(0, initial ? 'rgba(0,255,136,0.5)' : 'rgba(0,255,136,0.25)');
                grad.addColorStop(1, 'rgba(0,255,136,0)');
                ctx.fillStyle = grad;
                ctx.beginPath();
                ctx.arc(p.x, p.y, z.r, 0, Math.PI*2);
                ctx.fill();
                
                ctx.strokeStyle = initial ? 'rgba(0,255,136,0.8)' : 'rgba(0,255,136,0.4)';
                ctx.lineWidth = initial ? 3 : 2;
                ctx.setLineDash([5,5]);
                ctx.beginPath();
                ctx.arc(p.x, p.y, z.r, 0, Math.PI*2);
                ctx.stroke();
                ctx.setLineDash([]);
            });

            // å·²éƒ¨ç½²è®¾æ–½
            game.deployed.forEach(d => {
                const p = toScreen(d.x, d.y);
                const f = facilities[d.type];
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(f.icon, p.x, p.y);
                ctx.font = 'bold 10px Arial';
                ctx.fillStyle = '#00ff88';
                ctx.fillText('L'+d.level, p.x, p.y+14);
                ctx.fillStyle = '#fff';
            });

            // ç©å®¶ï¼ˆå±å¹•ä¸­å¿ƒï¼‰
            ctx.fillStyle = '#00ffff';
            ctx.shadowBlur = 15;
            ctx.shadowColor = '#00ffff';
            ctx.beginPath();
            ctx.arc(canvas.width/2, canvas.height/2, 12, 0, Math.PI*2);
            ctx.fill();
            ctx.shadowBlur = 0;

            requestAnimationFrame(render);
        }

        function update() {
            const sp = 4;
            if (game.keys['w'] || game.keys['ArrowUp']) game.player.y -= sp;
            if (game.keys['s'] || game.keys['ArrowDown']) game.player.y += sp;
            if (game.keys['a'] || game.keys['ArrowLeft']) game.player.x -= sp;
            if (game.keys['d'] || game.keys['ArrowRight']) game.player.x += sp;

            if (game.player.tx !== null) {
                const tx = game.player.tx + game.cam.x;
                const ty = game.player.ty + game.cam.y;
                const dx = tx - game.player.x;
                const dy = ty - game.player.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                if (dist > 3) {
                    game.player.x += (dx/dist) * sp;
                    game.player.y += (dy/dist) * sp;
                }
            }

            game.player.x = Math.max(15, Math.min(WORLD_SIZE-15, game.player.x));
            game.player.y = Math.max(15, Math.min(WORLD_SIZE-15, game.player.y));

            updateUI();
        }

        setInterval(() => {
            game.rate = game.deployed.reduce((s, d) => s + facilities[d.type].out * d.level, 0);
            game.points += game.rate;
            updateUI();
        }, 1000);

        function updateUI() {
            document.getElementById('evolutionPoints').textContent = Math.floor(game.points);
            document.getElementById('evolutionRate').textContent = '+' + game.rate + '/s';
            document.getElementById('deployedCount').textContent = game.deployed.length;
            document.getElementById('deployLimit').textContent = game.limit;

            const inZ = inZone();
            const hint = document.getElementById('statusHint');
            hint.textContent = inZ ? 'âœ“ å¯ä»¥éƒ¨ç½²' : 'ç§»åŠ¨åˆ°ç»¿è‰²åŒºåŸŸéƒ¨ç½²';
            hint.className = 'status-hint ' + (inZ ? 'in-zone' : 'out-zone');

            Object.keys(facilities).forEach(k => {
                const f = facilities[k];
                const btn = document.getElementById('btn-' + k);
                btn.disabled = !(inZ && game.points >= f.cost && game.deployed.length < game.limit);
            });

            const evCost = game.stage === 1 ? 100 : game.stage === 2 ? 500 : 2000;
            const evBtn = document.getElementById('evolveBtn');
            evBtn.style.display = game.points >= evCost ? 'block' : 'none';

            const list = document.getElementById('facilityList');
            list.innerHTML = game.deployed.map((d, i) => {
                const f = facilities[d.type];
                const out = f.out * d.level;
                const upCost = Math.floor(f.cost * Math.pow(1.5, d.level));
                return `<div class="facility-item">
                    <span>${f.icon} L${d.level} +${out}</span>
                    <span>
                        <button class="mini-btn" ${game.points>=upCost?'':'disabled'} onclick="upgrade(${i})">â¬†</button>
                        <button class="mini-btn" onclick="remove(${i})">ğŸ—‘</button>
                    </span>
                </div>`;
            }).join('');
        }

        function deploy(type) {
            if (!inZone()) return;
            const f = facilities[type];
            if (game.points < f.cost) return;
            if (game.deployed.length >= game.limit) {
                alert('éƒ¨ç½²ä¸Šé™ ' + game.limit + 'ï¼Œè¿›åŒ–åå¯å¢åŠ ');
                return;
            }
            game.points -= f.cost;
            game.deployed.push({ type, level: 1, x: game.player.x, y: game.player.y });
            updateUI();
        }

        function upgrade(i) {
            const d = game.deployed[i];
            const f = facilities[d.type];
            const cost = Math.floor(f.cost * Math.pow(1.5, d.level));
            if (game.points < cost) return;
            game.points -= cost;
            d.level++;
            updateUI();
        }

        function remove(i) {
            game.deployed.splice(i, 1);
            updateUI();
        }

        function evolve() {
            const cost = game.stage === 1 ? 100 : game.stage === 2 ? 500 : 2000;
            if (game.points < cost) return;
            game.points -= cost;
            game.stage++;
            game.limit += 3;
            document.getElementById('stageBadge').textContent = 
                game.stage === 2 ? 'å¤šç»†èƒ (2/3)' : game.stage === 3 ? 'æµ·æ´‹ç”Ÿç‰© (3/3)' : 'å·²å®Œæˆ';
            updateUI();
        }

        window.addEventListener('keydown', e => game.keys[e.key] = true);
        window.addEventListener('keyup', e => game.keys[e.key] = false);

        canvas.addEventListener('touchstart', e => {
            e.preventDefault();
            const t = e.touches[0];
            const r = canvas.getBoundingClientRect();
            game.player.tx = t.clientX - r.left;
            game.player.ty = t.clientY - r.top;
        }, {passive: false});

        canvas.addEventListener('touchmove', e => {
            e.preventDefault();
            const t = e.touches[0];
            const r = canvas.getBoundingClientRect();
            game.player.tx = t.clientX - r.left;
            game.player.ty = t.clientY - r.top;
        }, {passive: false});

        canvas.addEventListener('touchend', () => {
            game.player.tx = null;
            game.player.ty = null;
        });

        canvas.addEventListener('mousedown', e => {
            const r = canvas.getBoundingClientRect();
            game.player.tx = e.clientX - r.left;
            game.player.ty = e.clientY - r.top;
        });

        canvas.addEventListener('mouseup', () => {
            game.player.tx = null;
            game.player.ty = null;
        });

        window.addEventListener('resize', resize);
        resize();
        initZones();
        setInterval(update, 1000/60);
        render();
        updateUI();
    </script>
</body>
</html>
